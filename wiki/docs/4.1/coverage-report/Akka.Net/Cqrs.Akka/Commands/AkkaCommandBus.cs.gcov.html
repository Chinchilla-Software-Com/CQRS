<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - doc-coverage.info - Akka.Net/Cqrs.Akka/Commands/AkkaCommandBus.cs</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">Documentation Coverage Report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">Akka.Net/Cqrs.Akka/Commands</a> - AkkaCommandBus.cs</td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Version:</td>
            <td class="headerValue">4.0</td>
            <td></td>
            <td class="headerItem">Artefacts:</td>
            <td class="headerCovTableEntry">14</td>
            <td class="headerCovTableEntry">14</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2019-11-25 17:46:41</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<span class="lineNum">       1 </span>            : ï»¿#region Copyright
<span class="lineNum">       2 </span>            : // // -----------------------------------------------------------------------
<span class="lineNum">       3 </span>            : // // &lt;copyright company=&quot;Chinchilla Software Limited&quot;&gt;
<span class="lineNum">       4 </span>            : // //   Copyright Chinchilla Software Limited. All rights reserved.
<span class="lineNum">       5 </span>            : // // &lt;/copyright&gt;
<span class="lineNum">       6 </span>            : // // -----------------------------------------------------------------------
<span class="lineNum">       7 </span>            : #endregion
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : using System;
<span class="lineNum">      10 </span>            : using System.Collections.Concurrent;
<span class="lineNum">      11 </span>            : using System.Collections.Generic;
<span class="lineNum">      12 </span>            : using System.Linq;
<span class="lineNum">      13 </span>            : using Chinchilla.Logging;
<span class="lineNum">      14 </span>            : using Cqrs.Authentication;
<span class="lineNum">      15 </span>            : using Cqrs.Bus;
<span class="lineNum">      16 </span>            : using Cqrs.Commands;
<span class="lineNum">      17 </span>            : using Cqrs.Configuration;
<span class="lineNum">      18 </span>            : using Cqrs.Events;
<span class="lineNum">      19 </span>            : using Cqrs.Infrastructure;
<span class="lineNum">      20 </span>            : using Cqrs.Messages;
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : namespace Cqrs.Akka.Commands
<span class="lineNum">      23 </span>            : {
<span class="lineNum">      24 </span>            :         /// &lt;summary&gt;
<span class="lineNum">      25 </span>            :         /// A &lt;see cref=&quot;ICommandPublisher{TAuthenticationToken}&quot;/&gt; that resolves handlers , executes the handler and then publishes the &lt;see cref=&quot;ICommand{TAuthenticationToken}&quot;/&gt; on the public command bus.
<span class="lineNum">      26 </span>            :         /// &lt;/summary&gt;
<span class="lineNum">      27 </span>            :         /// &lt;typeparam name=&quot;TAuthenticationToken&quot;&gt;The &lt;see cref=&quot;Type&quot;/&gt; of the authentication token.&lt;/typeparam&gt;
<span class="lineNum">      28 </span>            :         public class AkkaCommandBus&lt;TAuthenticationToken&gt;
<span class="lineNum">      29 </span>            :                 : IAkkaCommandPublisher&lt;TAuthenticationToken&gt;
<span class="lineNum">      30 </span>            :                 , ICommandHandlerRegistrar
<span class="lineNum">      31 </span><span class="lineCov">          1 :         {</span>
<span class="lineNum">      32 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      33 </span>            :                 /// Gets the &lt;see cref=&quot;RouteManager&quot;/&gt;
<span class="lineNum">      34 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      35 </span>            :                 protected static RouteManager Routes { get; private set; }
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      38 </span>            :                 /// Gets or sets the &lt;see cref=&quot;IAuthenticationTokenHelper{TAuthenticationToken}&quot;&gt;Authentication Token Helper&lt;/see&gt;
<span class="lineNum">      39 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      40 </span>            :                 protected IAuthenticationTokenHelper&lt;TAuthenticationToken&gt; AuthenticationTokenHelper { get; private set; }
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      43 </span>            :                 /// Gets or sets the &lt;see cref=&quot;ICorrelationIdHelper&quot;/&gt;
<span class="lineNum">      44 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      45 </span>            :                 protected ICorrelationIdHelper CorrelationIdHelper { get; private set; }
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      48 </span>            :                 /// Gets or sets the &lt;see cref=&quot;IDependencyResolver&quot;/&gt;
<span class="lineNum">      49 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      50 </span>            :                 protected IDependencyResolver DependencyResolver { get; private set; }
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      53 </span>            :                 /// Gets or sets the &lt;see cref=&quot;IBusHelper&quot;/&gt;
<span class="lineNum">      54 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      55 </span>            :                 protected IBusHelper BusHelper { get; private set; }
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      58 </span>            :                 /// Gets or sets the &lt;see cref=&quot;ILogger&quot;/&gt;
<span class="lineNum">      59 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      60 </span>            :                 protected ILogger Logger { get; private set; }
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      63 </span>            :                 /// Gets or sets the &lt;see cref=&quot;ICommandPublisher{TAuthenticationToken}&quot;/&gt;
<span class="lineNum">      64 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      65 </span>            :                 protected ICommandPublisher&lt;TAuthenticationToken&gt; CommandPublisher { get; private set; }
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      68 </span>            :                 /// Gets or sets the &lt;see cref=&quot;ICommandReceiver{TAuthenticationToken}&quot;/&gt;
<span class="lineNum">      69 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      70 </span>            :                 protected ICommandReceiver&lt;TAuthenticationToken&gt; CommandReceiver { get; private set; }
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      73 </span>            :                 /// Gets or sets the current list of events waiting to be evaluated for &lt;see cref=&quot;PublishAndWait{TCommand,TEvent}(TCommand,Cqrs.Events.IEventReceiver{TAuthenticationToken})&quot;/&gt;
<span class="lineNum">      74 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      75 </span>            :                 protected IDictionary&lt;Guid, IList&lt;IEvent&lt;TAuthenticationToken&gt;&gt;&gt; EventWaits { get; private set; }
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            :                 static AkkaCommandBus()
<span class="lineNum">      78 </span>            :                 {
<span class="lineNum">      79 </span>            :                         Routes = new RouteManager();
<span class="lineNum">      80 </span>            :                 }
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      83 </span>            :                 /// Instantiates a new instance of &lt;see cref=&quot;AkkaCommandBus{TAuthenticationToken}&quot;/&gt;
<span class="lineNum">      84 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">      85 </span><span class="lineCov">          1 :                 public AkkaCommandBus(IBusHelper busHelper, IAuthenticationTokenHelper&lt;TAuthenticationToken&gt; authenticationTokenHelper, ICorrelationIdHelper correlationIdHelper, IDependencyResolver dependencyResolver, ILogger logger, ICommandPublisher&lt;TAuthenticationToken&gt; commandPublisher, ICommandReceiver&lt;TAuthenticationToken&gt; commandReceiver)</span>
<span class="lineNum">      86 </span>            :                 {
<span class="lineNum">      87 </span>            :                         Logger = logger;
<span class="lineNum">      88 </span>            :                         BusHelper = busHelper;
<span class="lineNum">      89 </span>            :                         AuthenticationTokenHelper = authenticationTokenHelper;
<span class="lineNum">      90 </span>            :                         CorrelationIdHelper = correlationIdHelper;
<span class="lineNum">      91 </span>            :                         DependencyResolver = dependencyResolver;
<span class="lineNum">      92 </span>            :                         EventWaits = new ConcurrentDictionary&lt;Guid, IList&lt;IEvent&lt;TAuthenticationToken&gt;&gt;&gt;();
<span class="lineNum">      93 </span>            :                         CommandPublisher = commandPublisher;
<span class="lineNum">      94 </span>            :                         CommandReceiver = commandReceiver;
<span class="lineNum">      95 </span>            :                 }
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">      98 </span>            :                 /// Sets the
<span class="lineNum">      99 </span>            :                 /// &lt;see cref=&quot;IMessageWithAuthenticationToken{TAuthenticationToken}.AuthenticationToken&quot;/&gt;,
<span class="lineNum">     100 </span>            :                 /// &lt;see cref=&quot;IMessage.CorrelationId&quot;/&gt;,
<span class="lineNum">     101 </span>            :                 /// &lt;see cref=&quot;IMessage.OriginatingFramework&quot;/&gt; to &quot;Akka&quot; and
<span class="lineNum">     102 </span>            :                 /// adds a value of &quot;Akka&quot; to the &lt;see cref=&quot;IMessage.Frameworks&quot;/&gt;
<span class="lineNum">     103 </span>            :                 /// if not already done so
<span class="lineNum">     104 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     105 </span><span class="lineCov">          1 :                 protected virtual void PrepareCommand&lt;TCommand&gt;(TCommand command)</span>
<span class="lineNum">     106 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     107 </span>            :                 {
<span class="lineNum">     108 </span>            :                         if (command.AuthenticationToken == null || command.AuthenticationToken.Equals(default(TAuthenticationToken)))
<span class="lineNum">     109 </span>            :                                 command.AuthenticationToken = AuthenticationTokenHelper.GetAuthenticationToken();
<span class="lineNum">     110 </span>            :                         command.CorrelationId = CorrelationIdHelper.GetCorrelationId();
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span>            :                         if (string.IsNullOrWhiteSpace(command.OriginatingFramework))
<span class="lineNum">     113 </span>            :                                 command.OriginatingFramework = &quot;Akka&quot;;
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span>            :                         var frameworks = new List&lt;string&gt;();
<span class="lineNum">     116 </span>            :                         if (command.Frameworks != null)
<span class="lineNum">     117 </span>            :                                 frameworks.AddRange(command.Frameworks);
<span class="lineNum">     118 </span>            :                         frameworks.Add(&quot;Akka&quot;);
<span class="lineNum">     119 </span>            :                         command.Frameworks = frameworks;
<span class="lineNum">     120 </span>            :                 }
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     123 </span>            :                 /// Locates a suitable &lt;see cref=&quot;ICommandValidator{TAuthenticationToken,TCommand}&quot;/&gt; to validate the provided &lt;paramref name=&quot;command&quot;/&gt; and validates the provided &lt;paramref name=&quot;command&quot;/&gt; if one is located
<span class="lineNum">     124 </span>            :                 /// Calls &lt;see cref=&quot;PrepareCommand{TCommand}&quot;/&gt;
<span class="lineNum">     125 </span>            :                 /// Checks if the provided &lt;paramref name=&quot;command&quot;/&gt; is required to be processed
<span class="lineNum">     126 </span>            :                 /// Locates a single &lt;see cref=&quot;RouteHandlerDelegate&quot;&gt;command handler&lt;/see&gt; for the provided &lt;paramref name=&quot;command&quot;/&gt;
<span class="lineNum">     127 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     128 </span>            :                 /// &lt;returns&gt;
<span class="lineNum">     129 </span>            :                 /// False if a suitable &lt;see cref=&quot;ICommandValidator{TAuthenticationToken,TCommand}&quot;/&gt; is located and the provided &lt;paramref name=&quot;command&quot;/&gt; fails validation,
<span class="lineNum">     130 </span>            :                 /// False if no &lt;see cref=&quot;RouteHandlerDelegate&quot;&gt;command handler&lt;/see&gt; is found but the command isn't required to be handled,
<span class="lineNum">     131 </span>            :                 /// True otherwise.
<span class="lineNum">     132 </span>            :                 /// &lt;/returns&gt;
<span class="lineNum">     133 </span><span class="lineCov">          1 :                 protected virtual bool PrepareAndValidateCommand&lt;TCommand&gt;(TCommand command, out RouteHandlerDelegate commandHandler)</span>
<span class="lineNum">     134 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     135 </span>            :                 {
<span class="lineNum">     136 </span>            :                         Type commandType = command.GetType();
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span>            :                         if (command.Frameworks != null &amp;&amp; command.Frameworks.Contains(&quot;Akka&quot;))
<span class="lineNum">     139 </span>            :                         {
<span class="lineNum">     140 </span>            :                                 // if this is the only framework in the list, then it's fine to handle as it's just pre-stamped, if there is more than one framework, then exit.
<span class="lineNum">     141 </span>            :                                 if (command.Frameworks.Count() != 1)
<span class="lineNum">     142 </span>            :                                 {
<span class="lineNum">     143 </span>            :                                         Logger.LogInfo(&quot;The provided command has already been processed in Akka.&quot;, string.Format(&quot;{0}\\PrepareAndValidateEvent({1})&quot;, GetType().FullName, commandType.FullName));
<span class="lineNum">     144 </span>            :                                         commandHandler = null;
<span class="lineNum">     145 </span>            :                                         return false;
<span class="lineNum">     146 </span>            :                                 }
<span class="lineNum">     147 </span>            :                         }
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span>            :                         ICommandValidator&lt;TAuthenticationToken, TCommand&gt; commandValidator = null;
<span class="lineNum">     150 </span>            :                         try
<span class="lineNum">     151 </span>            :                         {
<span class="lineNum">     152 </span>            :                                 commandValidator = DependencyResolver.Resolve&lt;ICommandValidator&lt;TAuthenticationToken, TCommand&gt;&gt;();
<span class="lineNum">     153 </span>            :                         }
<span class="lineNum">     154 </span>            :                         catch (Exception exception)
<span class="lineNum">     155 </span>            :                         {
<span class="lineNum">     156 </span>            :                                 Logger.LogDebug(&quot;Locating an ICommandValidator failed.&quot;, string.Format(&quot;{0}\\Handle({1})&quot;, GetType().FullName, commandType.FullName), exception);
<span class="lineNum">     157 </span>            :                         }
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            :                         if (commandValidator != null &amp;&amp; !commandValidator.IsCommandValid(command))
<span class="lineNum">     160 </span>            :                         {
<span class="lineNum">     161 </span>            :                                 Logger.LogInfo(&quot;The provided command is not valid.&quot;, string.Format(&quot;{0}\\Handle({1})&quot;, GetType().FullName, commandType.FullName));
<span class="lineNum">     162 </span>            :                                 commandHandler = null;
<span class="lineNum">     163 </span>            :                                 return false;
<span class="lineNum">     164 </span>            :                         }
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            :                         PrepareCommand(command);
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span>            :                         bool isRequired = BusHelper.IsEventRequired(commandType);
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span>            :                         commandHandler = Routes.GetSingleHandler(command, isRequired);
<span class="lineNum">     171 </span>            :                         // This check doesn't require an isRequired check as there will be an exception raised above and handled below.
<span class="lineNum">     172 </span>            :                         if (commandHandler == null)
<span class="lineNum">     173 </span>            :                                 Logger.LogDebug(string.Format(&quot;The command handler for '{0}' is not required.&quot;, commandType.FullName));
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span>            :                         return true;
<span class="lineNum">     176 </span>            :                 }
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span>            :                 #region Implementation of ICommandPublisher&lt;TAuthenticationToken&gt;
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     181 </span>            :                 /// Publishes the provided &lt;paramref name=&quot;command&quot;/&gt; on the command bus.
<span class="lineNum">     182 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     183 </span><span class="lineCov">          1 :                 public virtual void Publish&lt;TCommand&gt;(TCommand command)</span>
<span class="lineNum">     184 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     185 </span>            :                 {
<span class="lineNum">     186 </span>            :                         RouteHandlerDelegate commandHandler;
<span class="lineNum">     187 </span>            :                         if (!PrepareAndValidateCommand(command, out commandHandler))
<span class="lineNum">     188 </span>            :                                 return;
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span>            :                         // This could be null if Akka won't handle the command and something else will.
<span class="lineNum">     191 </span>            :                         if (commandHandler != null)
<span class="lineNum">     192 </span>            :                                 commandHandler.Delegate(command);
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            :                         // Let everything else know about the command (usually double handling a command is bad... but sometimes it might be useful... like pushing from AWS to Azure so both systems handle it... although an event really is the proper pattern to use here.
<span class="lineNum">     195 </span>            :                         CommandPublisher.Publish(command);
<span class="lineNum">     196 </span>            :                 }
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     199 </span>            :                 /// Publishes the provided &lt;paramref name=&quot;commands&quot;/&gt; on the command bus.
<span class="lineNum">     200 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     201 </span><span class="lineCov">          1 :                 public virtual void Publish&lt;TCommand&gt;(IEnumerable&lt;TCommand&gt; commands)</span>
<span class="lineNum">     202 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     203 </span>            :                 {
<span class="lineNum">     204 </span>            :                         IList&lt;TCommand&gt; sourceCommands = commands.ToList();
<span class="lineNum">     205 </span>            :                         foreach (TCommand command in sourceCommands)
<span class="lineNum">     206 </span>            :                         {
<span class="lineNum">     207 </span>            :                                 RouteHandlerDelegate commandHandler;
<span class="lineNum">     208 </span>            :                                 if (!PrepareAndValidateCommand(command, out commandHandler))
<span class="lineNum">     209 </span>            :                                         return;
<span class="lineNum">     210 </span>            : 
<span class="lineNum">     211 </span>            :                                 // This could be null if Akka won't handle the command and something else will.
<span class="lineNum">     212 </span>            :                                 if (commandHandler != null)
<span class="lineNum">     213 </span>            :                                         commandHandler.Delegate(command);
<span class="lineNum">     214 </span>            :                         }
<span class="lineNum">     215 </span>            :                         // Let everything else know about the command (usually double handling a command is bad... but sometimes it might be useful... like pushing from AWS to Azure so both systems handle it... although an event really is the proper pattern to use here.
<span class="lineNum">     216 </span>            :                         CommandPublisher.Publish((IEnumerable&lt;TCommand&gt;)sourceCommands);
<span class="lineNum">     217 </span>            :                 }
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     220 </span>            :                 /// Publishes the provided &lt;paramref name=&quot;command&quot;&gt;&lt;/paramref&gt; and waits for an event of &lt;typeparamref name=&quot;TEvent&quot;/&gt;
<span class="lineNum">     221 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     222 </span>            :                 /// &lt;param name=&quot;command&quot;&gt;The &lt;typeparamref name=&quot;TCommand&quot;/&gt; to publish.&lt;/param&gt;
<span class="lineNum">     223 </span>            :                 /// &lt;param name=&quot;eventReceiver&quot;&gt;If provided, is the &lt;see cref=&quot;IEventReceiver{TAuthenticationToken}&quot; /&gt; that the event is expected to be returned on.&lt;/param&gt;
<span class="lineNum">     224 </span><span class="lineCov">          1 :                 public virtual TEvent PublishAndWait&lt;TCommand, TEvent&gt;(TCommand command, IEventReceiver&lt;TAuthenticationToken&gt; eventReceiver = null)</span>
<span class="lineNum">     225 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     226 </span>            :                 {
<span class="lineNum">     227 </span>            :                         return PublishAndWait&lt;TCommand, TEvent&gt;(command, -1, eventReceiver);
<span class="lineNum">     228 </span>            :                 }
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     231 </span>            :                 /// Publishes the provided &lt;paramref name=&quot;command&quot;&gt;&lt;/paramref&gt; and waits for an event of &lt;typeparamref name=&quot;TEvent&quot;/&gt; or exits if the specified timeout is expired.
<span class="lineNum">     232 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     233 </span>            :                 /// &lt;param name=&quot;command&quot;&gt;The &lt;typeparamref name=&quot;TCommand&quot;/&gt; to publish.&lt;/param&gt;
<span class="lineNum">     234 </span>            :                 /// &lt;param name=&quot;millisecondsTimeout&quot;&gt;The number of milliseconds to wait, or &lt;see cref=&quot;F:System.Threading.Timeout.Infinite&quot;/&gt; (-1) to wait indefinitely.&lt;/param&gt;
<span class="lineNum">     235 </span>            :                 /// &lt;param name=&quot;eventReceiver&quot;&gt;If provided, is the &lt;see cref=&quot;IEventReceiver{TAuthenticationToken}&quot; /&gt; that the event is expected to be returned on.&lt;/param&gt;
<span class="lineNum">     236 </span><span class="lineCov">          1 :                 public virtual TEvent PublishAndWait&lt;TCommand, TEvent&gt;(TCommand command, int millisecondsTimeout, IEventReceiver&lt;TAuthenticationToken&gt; eventReceiver = null)</span>
<span class="lineNum">     237 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     238 </span>            :                 {
<span class="lineNum">     239 </span>            :                         return PublishAndWait(command, events =&gt; (TEvent)events.SingleOrDefault(@event =&gt; @event is TEvent), millisecondsTimeout, eventReceiver);
<span class="lineNum">     240 </span>            :                 }
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     243 </span>            :                 /// Publishes the provided &lt;paramref name=&quot;command&quot;&gt;&lt;/paramref&gt; and waits for an event of &lt;typeparamref name=&quot;TEvent&quot;/&gt; or exits if the specified timeout is expired.
<span class="lineNum">     244 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     245 </span>            :                 /// &lt;param name=&quot;command&quot;&gt;The &lt;typeparamref name=&quot;TCommand&quot;/&gt; to publish.&lt;/param&gt;
<span class="lineNum">     246 </span>            :                 /// &lt;param name=&quot;timeout&quot;&gt;A &lt;see cref=&quot;T:System.TimeSpan&quot;/&gt; that represents the number of milliseconds to wait, or a TimeSpan that represents -1 milliseconds to wait indefinitely.&lt;/param&gt;
<span class="lineNum">     247 </span>            :                 /// &lt;param name=&quot;eventReceiver&quot;&gt;If provided, is the &lt;see cref=&quot;IEventReceiver{TAuthenticationToken}&quot; /&gt; that the event is expected to be returned on.&lt;/param&gt;
<span class="lineNum">     248 </span><span class="lineCov">          1 :                 public virtual TEvent PublishAndWait&lt;TCommand, TEvent&gt;(TCommand command, TimeSpan timeout, IEventReceiver&lt;TAuthenticationToken&gt; eventReceiver = null)</span>
<span class="lineNum">     249 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     250 </span>            :                 {
<span class="lineNum">     251 </span>            :                         long num = (long)timeout.TotalMilliseconds;
<span class="lineNum">     252 </span>            :                         if (num &lt; -1L || num &gt; int.MaxValue)
<span class="lineNum">     253 </span>            :                                 throw new ArgumentOutOfRangeException(&quot;timeout&quot;, timeout, &quot;SpinWait_SpinUntil_TimeoutWrong&quot;);
<span class="lineNum">     254 </span>            :                         return PublishAndWait&lt;TCommand, TEvent&gt;(command, (int)timeout.TotalMilliseconds, eventReceiver);
<span class="lineNum">     255 </span>            :                 }
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     258 </span>            :                 /// Publishes the provided &lt;paramref name=&quot;command&quot;&gt;&lt;/paramref&gt; and waits until the specified condition is satisfied an event of &lt;typeparamref name=&quot;TEvent&quot;/&gt;
<span class="lineNum">     259 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     260 </span>            :                 /// &lt;param name=&quot;command&quot;&gt;The &lt;typeparamref name=&quot;TCommand&quot;/&gt; to publish.&lt;/param&gt;
<span class="lineNum">     261 </span>            :                 /// &lt;param name=&quot;condition&quot;&gt;A delegate to be executed over and over until it returns the &lt;typeparamref name=&quot;TEvent&quot;/&gt; that is desired, return null to keep trying.&lt;/param&gt;
<span class="lineNum">     262 </span>            :                 /// &lt;param name=&quot;eventReceiver&quot;&gt;If provided, is the &lt;see cref=&quot;IEventReceiver{TAuthenticationToken}&quot; /&gt; that the event is expected to be returned on.&lt;/param&gt;
<span class="lineNum">     263 </span><span class="lineCov">          1 :                 public virtual TEvent PublishAndWait&lt;TCommand, TEvent&gt;(TCommand command, Func&lt;IEnumerable&lt;IEvent&lt;TAuthenticationToken&gt;&gt;, TEvent&gt; condition, IEventReceiver&lt;TAuthenticationToken&gt; eventReceiver = null)</span>
<span class="lineNum">     264 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     265 </span>            :                 {
<span class="lineNum">     266 </span>            :                         return PublishAndWait(command, condition, -1, eventReceiver);
<span class="lineNum">     267 </span>            :                 }
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     270 </span>            :                 /// Publishes the provided &lt;paramref name=&quot;command&quot;&gt;&lt;/paramref&gt; and waits for an event of &lt;typeparamref name=&quot;TEvent&quot;/&gt; or exits if the specified timeout is expired.
<span class="lineNum">     271 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     272 </span>            :                 /// &lt;param name=&quot;command&quot;&gt;The &lt;typeparamref name=&quot;TCommand&quot;/&gt; to publish.&lt;/param&gt;
<span class="lineNum">     273 </span>            :                 /// &lt;param name=&quot;condition&quot;&gt;A delegate to be executed over and over until it returns the &lt;typeparamref name=&quot;TEvent&quot;/&gt; that is desired, return null to keep trying.&lt;/param&gt;
<span class="lineNum">     274 </span>            :                 /// &lt;param name=&quot;millisecondsTimeout&quot;&gt;The number of milliseconds to wait, or &lt;see cref=&quot;F:System.Threading.Timeout.Infinite&quot;/&gt; (-1) to wait indefinitely.&lt;/param&gt;
<span class="lineNum">     275 </span>            :                 /// &lt;param name=&quot;eventReceiver&quot;&gt;If provided, is the &lt;see cref=&quot;IEventReceiver{TAuthenticationToken}&quot; /&gt; that the event is expected to be returned on.&lt;/param&gt;
<span class="lineNum">     276 </span><span class="lineCov">          1 :                 public virtual TEvent PublishAndWait&lt;TCommand, TEvent&gt;(TCommand command, Func&lt;IEnumerable&lt;IEvent&lt;TAuthenticationToken&gt;&gt;, TEvent&gt; condition, int millisecondsTimeout, IEventReceiver&lt;TAuthenticationToken&gt; eventReceiver = null)</span>
<span class="lineNum">     277 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     278 </span>            :                 {
<span class="lineNum">     279 </span>            :                         if (eventReceiver != null)
<span class="lineNum">     280 </span>            :                                 throw new NotSupportedException(&quot;Specifying a different event receiver is not yet supported.&quot;);
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span>            :                         TEvent result = (TEvent)(object)null;
<span class="lineNum">     283 </span>            :                         EventWaits.Add(command.CorrelationId, new List&lt;IEvent&lt;TAuthenticationToken&gt;&gt;());
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span>            :                         Publish(command);
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span>            :                         SpinWait.SpinUntil(() =&gt;
<span class="lineNum">     288 </span>            :                         {
<span class="lineNum">     289 </span>            :                                 IList&lt;IEvent&lt;TAuthenticationToken&gt;&gt; events = EventWaits[command.CorrelationId];
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :                                 result = condition(events);
<span class="lineNum">     292 </span>            : 
<span class="lineNum">     293 </span>            :                                 return result != null;
<span class="lineNum">     294 </span>            :                         }, millisecondsTimeout, SpinWait.DefaultSleepInMilliseconds);
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span>            :                         return result;
<span class="lineNum">     297 </span>            :                 }
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     300 </span>            :                 /// Publishes the provided &lt;paramref name=&quot;command&quot;&gt;&lt;/paramref&gt; and waits for an event of &lt;typeparamref name=&quot;TEvent&quot;/&gt; or exits if the specified timeout is expired.
<span class="lineNum">     301 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     302 </span>            :                 /// &lt;param name=&quot;command&quot;&gt;The &lt;typeparamref name=&quot;TCommand&quot;/&gt; to publish.&lt;/param&gt;
<span class="lineNum">     303 </span>            :                 /// &lt;param name=&quot;condition&quot;&gt;A delegate to be executed over and over until it returns the &lt;typeparamref name=&quot;TEvent&quot;/&gt; that is desired, return null to keep trying.&lt;/param&gt;
<span class="lineNum">     304 </span>            :                 /// &lt;param name=&quot;timeout&quot;&gt;A &lt;see cref=&quot;T:System.TimeSpan&quot;/&gt; that represents the number of milliseconds to wait, or a TimeSpan that represents -1 milliseconds to wait indefinitely.&lt;/param&gt;
<span class="lineNum">     305 </span>            :                 /// &lt;param name=&quot;eventReceiver&quot;&gt;If provided, is the &lt;see cref=&quot;IEventReceiver{TAuthenticationToken}&quot; /&gt; that the event is expected to be returned on.&lt;/param&gt;
<span class="lineNum">     306 </span><span class="lineCov">          1 :                 public virtual TEvent PublishAndWait&lt;TCommand, TEvent&gt;(TCommand command, Func&lt;IEnumerable&lt;IEvent&lt;TAuthenticationToken&gt;&gt;, TEvent&gt; condition, TimeSpan timeout, IEventReceiver&lt;TAuthenticationToken&gt; eventReceiver = null)</span>
<span class="lineNum">     307 </span>            :                         where TCommand : ICommand&lt;TAuthenticationToken&gt;
<span class="lineNum">     308 </span>            :                 {
<span class="lineNum">     309 </span>            :                         long num = (long)timeout.TotalMilliseconds;
<span class="lineNum">     310 </span>            :                         if (num &lt; -1L || num &gt; int.MaxValue)
<span class="lineNum">     311 </span>            :                                 throw new ArgumentOutOfRangeException(&quot;timeout&quot;, timeout, &quot;SpinWait_SpinUntil_TimeoutWrong&quot;);
<span class="lineNum">     312 </span>            :                         return PublishAndWait(command, condition, (int)timeout.TotalMilliseconds, eventReceiver);
<span class="lineNum">     313 </span>            :                 }
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span>            :                 #endregion
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span>            :                 #region Implementation of IHandlerRegistrar
<span class="lineNum">     318 </span>            : 
<span class="lineNum">     319 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     320 </span>            :                 /// Register an event or command handler that will listen and respond to events or commands.
<span class="lineNum">     321 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     322 </span><span class="lineCov">          1 :                 public void RegisterHandler&lt;TMessage&gt;(Action&lt;TMessage&gt; handler, Type targetedType, bool holdMessageLock = true)</span>
<span class="lineNum">     323 </span>            :                         where TMessage : IMessage
<span class="lineNum">     324 </span>            :                 {
<span class="lineNum">     325 </span>            :                         Routes.RegisterHandler(handler, targetedType, holdMessageLock);
<span class="lineNum">     326 </span>            :                 }
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span>            :                 /// &lt;summary&gt;
<span class="lineNum">     329 </span>            :                 /// Register an event or command handler that will listen and respond to events or commands.
<span class="lineNum">     330 </span>            :                 /// &lt;/summary&gt;
<span class="lineNum">     331 </span><span class="lineCov">          1 :                 public void RegisterHandler&lt;TMessage&gt;(Action&lt;TMessage&gt; handler, bool holdMessageLock = true)</span>
<span class="lineNum">     332 </span>            :                         where TMessage : IMessage
<span class="lineNum">     333 </span>            :                 {
<span class="lineNum">     334 </span>            :                         RegisterHandler(handler, null);
<span class="lineNum">     335 </span>            :                 }
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span>            :                 #endregion
<span class="lineNum">     338 </span>            :         }
<span class="lineNum">     339 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
